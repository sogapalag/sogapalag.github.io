<!DOCTYPE html>





<html class="theme-next gemini use-motion" lang="en">
<head>
  <meta charset="UTF-8">
<meta name="generator" content="Hexo 3.9.0">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.3.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.3.0">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.3.0">
  <link rel="mask-icon" href="/images/logo.svg?v=7.3.0" color="#222">

<link rel="stylesheet" href="/css/main.css?v=7.3.0">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">


<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.3.0',
    sidebar: {"position":"right","display":"post","offset":12,"onmobile":false},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    search: {
      root: '/',
      path: ''
    },
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: 'Copy',
      copy_success: 'Copied',
      copy_failure: 'Copy failed'
    }
  };
</script>

  <meta property="og:type" content="website">
<meta property="og:title">
<meta property="og:url" content="https://sogapalag.github.io/index.html">
<meta property="og:site_name">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title">
  <link rel="canonical" href="https://sogapalag.github.io/">


<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title></title>
  








  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  <div class="container sidebar-position-right page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title"></span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
    <ul id="menu" class="menu">
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>
    </ul>
</nav>

</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
            

          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://sogapalag.github.io/2021/05/11/Implementing-Tree-like-Data-Structure-in-Rust/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhaopeng Yan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2021/05/11/Implementing-Tree-like-Data-Structure-in-Rust/" class="post-title-link" itemprop="url">Implementing Tree-like Data Structure in Rust</a>
              
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2021-05-11 20:26:11 / Modified: 20:44:09" itemprop="dateCreated datePublished" datetime="2021-05-11T20:26:11+08:00">2021-05-11</time>
            </span>
          
            

            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/implementation/" itemprop="url" rel="index"><span itemprop="name">implementation</span></a></span>

                
                
              
            </span>
          

          <br>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h2 id="Helpful-links"><a href="#Helpful-links" class="headerlink" title="Helpful links"></a>Helpful links</h2><ul>
<li><a href="https://doc.rust-lang.org/src/alloc/collections/btree/node.rs.html" target="_blank" rel="noopener"><code>std</code> btree</a></li>
<li><a href="https://rust-unofficial.github.io/too-many-lists/index.html" target="_blank" rel="noopener">Too many linked lists</a></li>
<li><a href="https://doc.rust-lang.org/nomicon/" target="_blank" rel="noopener">unsafe book</a></li>
</ul>
<h1 id="Intro"><a href="#Intro" class="headerlink" title="Intro"></a>Intro</h1><p>To implement BST, treap, splay, etc. There is a popular style(among competitive programmers) using raw <code>usize</code> as pointer, each member alloc each array, i.e. a pure data layout which require one understand connection between members, despite its pros and cons, this blog is talking about a standard pointer fashion implementation.</p>
<h1 id="Trivial-BST"><a href="#Trivial-BST" class="headerlink" title="Trivial BST"></a>Trivial BST</h1><p>After some googling and reading, one can find the simple pattern.</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Node</span></span>&lt;T&gt; &#123;</span><br><span class="line">    val: T,</span><br><span class="line">    left: <span class="built_in">Option</span>&lt;<span class="built_in">Box</span>&lt;Node&lt;T&gt;&gt;&gt;,</span><br><span class="line">    right: <span class="built_in">Option</span>&lt;<span class="built_in">Box</span>&lt;Node&lt;T&gt;&gt;&gt;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Based on that we can implement a simple BST. And we don’t need care <code>Drop</code> since <code>Box</code> is owned pointer. So its shortage is obvious too since its ownership is tree-like.</p>
<h1 id="Oh-cycle"><a href="#Oh-cycle" class="headerlink" title="Oh cycle"></a>Oh cycle</h1><p>It happend when we want a parent pointer. This cycle pointer pattern conflicts to ownership. After some googling and read <code>std</code>. One could find a pattern</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Node</span></span>&lt;V&gt; &#123;</span><br><span class="line">    val: V,</span><br><span class="line">    left: Link&lt;V&gt;,</span><br><span class="line">    right: Link&lt;V&gt;,</span><br><span class="line">    parent: Link&lt;V&gt;,</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">type</span> <span class="title">Link</span></span>&lt;V&gt; = <span class="built_in">Option</span>&lt;Rc&lt;RefCell&lt;Node&lt;V&gt;&gt;&gt;&gt;;</span><br></pre></td></tr></table></figure>

<p>Ohh, things start dirty now.<br>It seems provide multi-owner and interior mutability which might be powerful. But hell no, you have to deal with lifetime when <code>Ref</code>.<br>You have to use <code>Weak</code> for parent, since <a href="https://doc.rust-lang.org/book/ch15-06-reference-cycles.html" target="_blank" rel="noopener">ref cycle can leak memory</a>.<br>And when you want to impl iterator, ownership and lifetime will stop you. The big problem is when you iter something which might be poped.</p>
<h1 id="unsafe-btree"><a href="#unsafe-btree" class="headerlink" title="unsafe, btree"></a>unsafe, btree</h1><p>The whole problem is almost unresolvable since we still use a <strong>ownership</strong> system to create <strong>cyclic</strong> stuff, so let’s embrace <code>unsafe</code> raw pointers, to discard ownership, and rely on own belief.</p>
<p>Look at <code>BTree</code> of <code>std</code>, they don’t use <code>Rc</code> or <code>RefCell</code> at all.<br>Simplified data layout:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">LN &#123; parent: Op&lt;BN&gt;, [k], [v] &#125; </span><br><span class="line">BN &#123; *LN &#125;</span><br><span class="line">NR &#123; node: *LN &#125;</span><br><span class="line">IN &#123; LN, [BN] &#125;</span><br></pre></td></tr></table></figure>

<p>Where LeafNode as LN, BoxedNode as BN, NodeRef as NR, InternalNode as IN.<br><code>BTree</code> is well space optimized with many unsed null pointer issue.</p>
<h1 id="persistent-immutable"><a href="#persistent-immutable" class="headerlink" title="persistent/immutable"></a>persistent/immutable</h1><p><code>Option&lt;Rc&lt;Node&gt;&gt;</code> is suitable with <code>Rc::make_mut</code>. And parent pointer is meaningless.</p>
<h2 id="generic-HKT"><a href="#generic-HKT" class="headerlink" title="generic? HKT"></a>generic? HKT</h2><p>It’s almost same when create immutable data structure, by replace <code>Box</code> with <code>Rc</code>, and <code>make_mut</code>. But there isn’t higher kinded type in rust. i.e. we cannot generic on C of <code>C&lt;Node&gt;</code>, so need help of macro, lost of some IDE analysis hints when wrapper into macro. A similar HKT pattern is <code>collect</code>, but of course which isn’t HKT.</p>
<h2 id="wrapper-newtype-or-trait-for-link-pointer"><a href="#wrapper-newtype-or-trait-for-link-pointer" class="headerlink" title="wrapper newtype or trait for link/pointer"></a>wrapper newtype or trait for link/pointer</h2><p>Must choose one, due to orphan rule.</p>
<h2 id="array"><a href="#array" class="headerlink" title="array"></a>array</h2><p>Low level code need array instead of Vec, but array is in-friendly using for initialization and other issue, unless you introduce some exist modules with array functionality. Otherwise another wheel you need to create by your own.</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>Raw pointers is fast indeed, but hard to debug, unless one has perfect understanding. Rust support different kinds of pointers for different circumstances, it indeed help a lot for to understand the potential bugs, but not perfect, especially when cyclic. The tricky part is find some middle point between safe and unsafe rust.</p>

          
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
    </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://sogapalag.github.io/2021/03/30/Algebraic-Structure-Generic-and-Design-Pattern-of-Rust/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhaopeng Yan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2021/03/30/Algebraic-Structure-Generic-and-Design-Pattern-of-Rust/" class="post-title-link" itemprop="url">Algebraic Structure: Generic and Design Pattern of Rust</a>
              
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2021-03-30 00:32:09" itemprop="dateCreated datePublished" datetime="2021-03-30T00:32:09+08:00">2021-03-30</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2021-04-02 15:27:47" itemprop="dateModified" datetime="2021-04-02T15:27:47+08:00">2021-04-02</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/implementation/" itemprop="url" rel="index"><span itemprop="name">implementation</span></a></span>

                
                
              
            </span>
          

          <br>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>In last blog, I briefly discussed fenwick tree and monoid. Since it happens in many scenarios, e.g. segment tree. This blog begins by how to implement one fenwick tree with rust. But technically this blog is to talk about dealing with generic, about <strong>code reuse and flexibility</strong>.<br>Before continue reading, make sure you know basic <a href="https://en.wikipedia.org/wiki/Monoid" target="_blank" rel="noopener">monoid</a> and <a href="https://www.rust-lang.org/" target="_blank" rel="noopener">rust</a>.</p>
<h2 id="Review-on-Fenwick"><a href="#Review-on-Fenwick" class="headerlink" title="Review on Fenwick"></a>Review on Fenwick</h2><p>A widely used implementation of fenwick is something like</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">add</span></span>(i: <span class="built_in">usize</span>, x: <span class="built_in">i32</span>) &#123; <span class="comment">/* modify a[i] */</span> &#125;</span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">sum</span></span>(i: <span class="built_in">usize</span>) &#123; <span class="comment">/* read a[i] */</span> &#125;</span><br></pre></td></tr></table></figure>

<p>We omit details, just knowing that we’re to implement something operating on array.<br>As long as we understand that fenwick require monoid indeed, and we want to generalize it for code reuse.</p>
<h2 id="Different-Versions"><a href="#Different-Versions" class="headerlink" title="Different Versions"></a>Different Versions</h2><h3 id="Abstract-type-away-with-struct-generic-and-trait"><a href="#Abstract-type-away-with-struct-generic-and-trait" class="headerlink" title="Abstract type away with struct generic and trait"></a>Abstract type away with struct generic and trait</h3><p>This would be coming into thought by almost all programmers. For c++, <code>template &lt;typename T=int&gt;</code>. For rust, we have to add trait bound for type safety. Code as below</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Fenwick</span></span>&lt;T&gt; &#123; a: <span class="built_in">Vec</span>&lt;T&gt;, &#125;</span><br><span class="line"><span class="keyword">impl</span>&lt;T: std::ops::Add&gt; Fenwick&lt;T&gt; &#123; <span class="comment">/*omit*/</span>&#125;</span><br></pre></td></tr></table></figure>

<p>Thus by using <code>std</code> traits we abstract <code>i32</code> away with <code>T</code>, now we can use it any numeric type and our own modular integer type.</p>
<p><strong>Pros</strong>: easy to implement, first come into thought, easy to understand.<br><strong>Cons</strong>: very limited, we can operate with <code>+</code> only.</p>
<p>This is actually use <code>+</code> to represent any monoid operation, what if we want to use another widely used operation <code>max</code>?</p>
<h3 id="Pass-functor-as-argument"><a href="#Pass-functor-as-argument" class="headerlink" title="Pass functor as argument"></a>Pass functor as argument</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Fenwick</span></span>&lt;T&gt; &#123; a: <span class="built_in">Vec</span>&lt;T&gt;, f: <span class="function"><span class="keyword">fn</span></span>(T,T)-&gt;T, &#125;</span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Fenwick&lt;T&gt; &#123; <span class="function"><span class="keyword">fn</span> <span class="title">new</span></span>(f: <span class="function"><span class="keyword">fn</span></span>(T,T)-&gt;T) &#123;&#125; &#125;</span><br></pre></td></tr></table></figure>

<p>This implementation doesn’t require trait at all, since we put it into <code>fn</code> already.</p>
<p><strong>Pros</strong>: This is indeed a powerful way, easy to understand, can handle most cases in a rapid implementation.<br><strong>Cons</strong>: Each cases need pass one rewrite functor. Each instance own one functor. What if extend with 2D? How to separate monoid and group?</p>
<p>Note here we might use <code>dyn Trait</code> for some generics, and to pass closure. But this will get hand much more dirty. And the key that’s not welcome basically because its <em>instance own shared behavior</em>. And for dealing with <code>+</code> and <code>max</code>, we might need to pass additional functor <code>-</code>, maybe need to wrapper it to separate inverse.</p>
<p>But anyway this still a great method if you need a quickly usable template. And some segment trees are implemented in this style. And usually along with custom type each case.</p>
<h3 id="NewType-generic-with-introduced-monoid-trait"><a href="#NewType-generic-with-introduced-monoid-trait" class="headerlink" title="NewType generic with introduced monoid trait"></a>NewType generic with introduced monoid trait</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">Monoid</span></span> &#123; <span class="function"><span class="keyword">fn</span> <span class="title">binop</span></span>(x: <span class="keyword">Self</span>, y: <span class="keyword">Self</span>) -&gt; <span class="keyword">Self</span>; &#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Name</span></span>&lt;T&gt;(T);</span><br><span class="line"><span class="keyword">impl</span>&lt;T&gt; Monoid <span class="keyword">for</span> Name&lt;T&gt; &#123; </span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">binop</span></span>(x: <span class="keyword">Self</span>, y: <span class="keyword">Self</span>) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        x + y <span class="comment">// or other function</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Fenwick</span></span>&lt;T&gt; &#123; a: <span class="built_in">Vec</span>&lt;T&gt;, &#125;</span><br><span class="line"><span class="keyword">impl</span>&lt;T: Monoid&gt; Fenwick&lt;T&gt; &#123; <span class="comment">/*omit*/</span> &#125;</span><br></pre></td></tr></table></figure>

<p>This method, we abstract same operation on different type, e.g. <code>Name</code> can be <code>Max</code>, thus we can write some code with generic or macros.</p>
<p><strong>Pros</strong>: Make sense, monoid is indeed $(A, *)$, for each space $A$ we use new type <code>Name&lt;T&gt;</code>, and <code>Name</code> for generic with similar behavior.<br><strong>Cons</strong>: This is not practical literally, mainly because we use type wrapper, which sacrifice the many built-in functionality of inner type <code>T</code>.</p>
<p>To implement <a href="https://doc.rust-lang.org/book/ch19-04-advanced-types.html" target="_blank" rel="noopener">NewType</a> support some functionality, we either need to implement many other traits, e.g. <code>Display</code> and <code>From&lt;T&gt;</code>, still loss of the power of primitive type and inconvenient, and heavy macro is must needed, since you are dealing with type generic. Or implement <code>Deref</code> for escape writing bunch of code, but not idiom, and still kind of inconvenient, since <code>Name&lt;T&gt;</code> and <code>T</code> are indeed different type even if you implement <code>Deref</code>.</p>
<h3 id="Ultimate-trait-generic-with-empty-struct"><a href="#Ultimate-trait-generic-with-empty-struct" class="headerlink" title="Ultimate: trait generic with empty struct."></a>Ultimate: trait generic with empty struct.</h3><p>Before write any code, let’s talk about <strong><a href="https://en.wikipedia.org/wiki/Algebraic_structure" target="_blank" rel="noopener">algebraic structure</a></strong> in the blog title! A monoid is $(A, *, e)$, one space, one binary operation, and identity element. In implementation, it varies by $(A, *)$, and we want it as some component, since we can attach some other component, e.g. group component inverse.<br>And note there is a subtle deference between mathematical $A$ and <code>T</code>, we don’t want them as bijection since some <code>T</code> might have similar functionality, e.g. <code>i32</code> and <code>i64</code> shared almost same integer space mathematically, but they’re different type since we’re dealing with real world restriction. Which is the part we wanna do some generic.</p>
<p>What are we actually want for fenwick generic to support flexibility?</p>
<ul>
<li>A generic <code>T</code></li>
<li>A generic <code>Op</code></li>
</ul>
<p>That’s it, flexible (<code>T</code>x<code>Op</code>) space, and we can write some generic code of square subspace of it.<br>The kind of counter-intuitive part instead treat <code>Op</code> as functor, which is naturally lead us to above implementations.<br>Just follow what we want, we should write something like</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Fenwick</span></span>&lt;T,Op&gt; &#123;&#125;</span><br><span class="line"><span class="keyword">let</span> a = Fenwick::&lt;<span class="built_in">i32</span>, Add&gt;; <span class="comment">// when as usage</span></span><br></pre></td></tr></table></figure>

<p>Then connection between <code>T</code> and <code>Op</code> by trait <code>Monoid</code> bounds.<br>Note here <code>Op</code> is a complete empty struct, itself doesn’t provide any method, since it wouldn’t know other space <code>T</code>. It’s used just as name, to describe one genre operation, we can write generic code then.<br>And there is a subtle difference between <strong>trait generic</strong> and <strong>associated type</strong>, one can read this <a href="https://blog.thomasheartman.com/posts/on-generics-and-associated-types" target="_blank" rel="noopener">blog</a>. In short, trait generic are indeed different trait, but trait with associated type are same trait, which latter wouldn’t match our requirement, since each point on (<code>T</code>x<code>Op</code>) space are considered different from other.<br>Now we have two options</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">impl</span> Monoid&lt;T&gt; <span class="keyword">for</span> Op &#123;&#125;</span><br><span class="line"><span class="keyword">impl</span> Monoid&lt;Op&gt; <span class="keyword">for</span> T &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>Obviously we should choose latter, since it will bring <code>T</code> into <code>Monoid</code>‘s scope, and <code>Op</code> matches its naming functionality. I lift that to just remind <code>T</code> and <code>Op</code> are same in space sense.<br>Now an example code as below</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> std::marker::PhantomData;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">trait</span> <span class="title">Monoid</span></span>&lt;M&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> ID: <span class="keyword">Self</span>;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">binop</span></span>(x: <span class="keyword">Self</span>, y: <span class="keyword">Self</span>) -&gt; <span class="keyword">Self</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Fenwick</span></span>&lt;T,Op&gt; &#123;</span><br><span class="line">    a: <span class="built_in">Vec</span>&lt;T&gt;,</span><br><span class="line">    _m: PhantomData&lt;Op&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span>&lt;T,Op&gt; Fenwick&lt;T,Op&gt;</span><br><span class="line">    <span class="keyword">where</span> T: Monoid&lt;Op&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* omit */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// for generic we must use macro since we're writing trait-impl.</span></span><br><span class="line"><span class="comment">// if we wanna work around it, need to introduce more traits into it for trait bound.</span></span><br><span class="line"><span class="comment">// or maybe in future edition we can have algebra type match feature in trait-impl i32|i64</span></span><br><span class="line"><span class="comment">// but luckily the macro is easy to do.</span></span><br><span class="line"><span class="comment">// Since below part is pretty easy to abstract same content out.</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Add</span></span>;</span><br><span class="line"><span class="comment">// for exact point impl</span></span><br><span class="line"><span class="keyword">impl</span> Monoid&lt;Add&gt; <span class="keyword">for</span> <span class="built_in">i32</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> ID: <span class="keyword">Self</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">binop</span></span>(x: <span class="keyword">Self</span>, y: <span class="keyword">Self</span>) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        x + y</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>()&#123;</span><br><span class="line">    <span class="keyword">let</span> a = Fenwick::&lt;<span class="built_in">i32</span>,Add&gt;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Pros</strong>: match exactly we want, idiomatic, flexible, easy to API use.<br><strong>Cons</strong>: too many preliminaries lead to this generic implementation. Cannot use the operator overload benefit.</p>
<p>For more implementation detail, see my library(TODO unpublished now).</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Rust provide various generic, different choice would result different design pattern, think twice before implementation.</p>

          
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
    </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://sogapalag.github.io/2021/03/30/A-Brief-Discussion-on-Fenwick-Tree/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhaopeng Yan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2021/03/30/A-Brief-Discussion-on-Fenwick-Tree/" class="post-title-link" itemprop="url">A Brief Discussion on Fenwick Tree</a>
              
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2021-03-30 00:10:47 / Modified: 00:26:00" itemprop="dateCreated datePublished" datetime="2021-03-30T00:10:47+08:00">2021-03-30</time>
            </span>
          
            

            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/implementation/" itemprop="url" rel="index"><span itemprop="name">implementation</span></a></span>

                
                
              
            </span>
          

          <br>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>Fenwick tree(aka. binary index tree, BIT), which core technique is about LSB(least significant bit) manipulation.<br>Each index has the form $p+2^k$, when doing add operation, it moves to next index $p+2^k+2^k$.</p>
<h3 id="Corollary"><a href="#Corollary" class="headerlink" title="Corollary"></a>Corollary</h3><blockquote>
<p>Index $p+2^k$ guards $p+[2^k]$.</p>
</blockquote>
<p>i.e. $p+2^k$ stores operations of $p+x, \forall x, 1\leq x\leq 2^k$.</p>
<p>Thus sum works by $\sum_{i\in[p+2^k]} = \sum_{i\in[p]} + \sum_{i\in p+[2^k]}$.</p>
<h2 id="Algebraic-structure"><a href="#Algebraic-structure" class="headerlink" title="Algebraic structure"></a>Algebraic structure</h2><p>Before to explore additional implementation, let us talk about algebra a little, which I will write another blog to explain more. But for now, just a little.</p>
<h3 id="Monoid"><a href="#Monoid" class="headerlink" title="Monoid"></a>Monoid</h3><p>If you familiar with fenwick tree, you might know the widely used <em>add</em> operation is not only <em>add</em>, but also <em>max</em> and <em>min</em> could be. They’re indeed <strong>monoid</strong>.</p>
<p>Now let’s abstract them.</p>
<ul>
<li>$a_i + x$. =&gt; $a_i * x$. where $*$ as general monoid operation.</li>
<li>sum prefix. =&gt; $((a_0 * a_1) *\cdots *a_n)$. work by the associativity.</li>
</ul>
<p>One can realize we can use <em>sub</em> for non-prefix range when using <em>add</em>, but not the case <em>max</em> or <em>min</em>. Because <em>add</em> makes <strong>group</strong> by its inverse operation <em>sub</em>.</p>
<p>Now we understand fenwick require monoid, so we can bring more operations into it. e.g. bit operations <em>xor</em>, <em>or</em>, <em>and</em>. Can we introduce more? Yes!</p>
<p>We’re using above monoids with <strong>commutativity</strong> implicitly. We can actually use non-commutative monoids, e.g. bracket matching. We can use it in fenwick tree too, but in a strict way, only when our modify operation occurs in monotonic order. With careful implementation, it doesn’t require commutativity.</p>
<h2 id="Methods"><a href="#Methods" class="headerlink" title="Methods"></a>Methods</h2><p>One useful method is <strong>binary search</strong> on fenwick tree. By above discussion, we now understand it can be implemented on <em>max</em> too. Since we just need to ensure prefix sum is sorted. And by the corollary, one can easily implement it with deciding bits from high to low.</p>

          
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
    </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://sogapalag.github.io/2020/05/27/v2ray-ws-tls-settings/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhaopeng Yan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2020/05/27/v2ray-ws-tls-settings/" class="post-title-link" itemprop="url">v2ray (ws+tls) settings</a>
              
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-05-27 00:35:08 / Modified: 02:00:38" itemprop="dateCreated datePublished" datetime="2020-05-27T00:35:08+08:00">2020-05-27</time>
            </span>
          
            

            
          

          <br>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h2 id="Helpful-links"><a href="#Helpful-links" class="headerlink" title="Helpful links"></a>Helpful links</h2><ul>
<li>server: (<a href="https://github.com/wulabing/V2Ray_ws-tls_bash_onekey" target="_blank" rel="noopener">https://github.com/wulabing/V2Ray_ws-tls_bash_onekey</a>)</li>
<li>client config format: (<a href="https://www.lingbaoboy.com/2019/03/v2raywebsocket-tls-web.html" target="_blank" rel="noopener">https://www.lingbaoboy.com/2019/03/v2raywebsocket-tls-web.html</a>) </li>
<li>format document: (<a href="https://www.v2ray.com/chapter_02/01_overview.html#inboundobject" target="_blank" rel="noopener">https://www.v2ray.com/chapter_02/01_overview.html#inboundobject</a>)</li>
<li>format document(mirror): (<a href="https://www.bookstack.cn/read/V2RAY/chapter_02-05_transport.md" target="_blank" rel="noopener">https://www.bookstack.cn/read/V2RAY/chapter_02-05_transport.md</a>)</li>
<li>port pint test: (<a href="http://port.ping.pe/" target="_blank" rel="noopener">http://port.ping.pe/</a>)</li>
<li>kill agent of ali cloud: (<a href="https://www.wanvi.net/15170.html" target="_blank" rel="noopener">https://www.wanvi.net/15170.html</a>)</li>
<li>kill agent of tencent cloud: (<a href="https://cloud.tencent.com/developer/article/1381482" target="_blank" rel="noopener">https://cloud.tencent.com/developer/article/1381482</a>)</li>
<li>google mirrors: (<a href="https://www.uedbox.com/post/54776/" target="_blank" rel="noopener">https://www.uedbox.com/post/54776/</a>)</li>
</ul>
<h2 id="You-really-want-build-your-own"><a href="#You-really-want-build-your-own" class="headerlink" title="You really want build your own?"></a>You really want build your own?</h2><p>There’re plenty of instructions-links online. But it’s painful to build before you succeed(especially if you’re inside the wall). So if you just wanna use it, search online and buy one(which is much easier, quicker and cheaper). If you really want to build your own, please continue reading.</p>
<h2 id="Steps"><a href="#Steps" class="headerlink" title="Steps"></a>Steps</h2><ol>
<li>prep a fresh domain(with dns to your server IP).</li>
<li>excute the script on your server.</li>
<li>configure your local config.</li>
</ol>
<p>Pretty easy, huh. But it would be suffer for a newbie. I write down some notes, but cannot include all issues of course.</p>
<h4 id="where-to-get-domain"><a href="#where-to-get-domain" class="headerlink" title="where to get domain?"></a>where to get domain?</h4><p>Many links tell you to get a free, but most links are 404 since you still inside. So I suggest you buy one(search your own) with 1~10 RMB/year. AliCloud and TencentCloud are easy to get, but require your verfied ID.</p>
<h4 id="dns-to-your-server-IP"><a href="#dns-to-your-server-IP" class="headerlink" title="dns to your server IP"></a>dns to your server IP</h4><p>create “A”, host name can remain blank “@”, just write your server IP on value/ip part.</p>
<h4 id="where-to-get-vps"><a href="#where-to-get-vps" class="headerlink" title="where to get vps?"></a>where to get vps?</h4><p>This might be an annoying part. Most foreign vps’s payment are visa or paypal, or their web 404. So your choice are very limited. Remember to kill agent clearly if you choose Ali or Tencent.</p>
<h4 id="install-client-v2ray"><a href="#install-client-v2ray" class="headerlink" title="install client v2ray"></a>install client v2ray</h4><p>how to unzip unzip.zip file? look for help from your friend… hope there might be some mirror sites in future?<br>or find some other method.</p>
<h4 id="update-client-v2ray-to-latest-version"><a href="#update-client-v2ray-to-latest-version" class="headerlink" title="update client v2ray to latest version"></a>update client v2ray to latest version</h4><p>seem like above. well, you can just create an hourly vps to build the trivial v2ray for downloading.</p>
<h4 id="install-locally"><a href="#install-locally" class="headerlink" title="install locally"></a>install locally</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash go.sh --<span class="built_in">local</span> /path/to/your_v2ray.zip</span><br></pre></td></tr></table></figure>

<h4 id="config-file-for-linux-user"><a href="#config-file-for-linux-user" class="headerlink" title="config file for linux user"></a>config file for linux user</h4><p>there is not many links online, since most windows/mac/ios user can have some app just scan QR code or paste url.(hope a linux app future?) check the format link in the beginning, and I also put a paste below.</p>
<details>
<summary> config.json </summary>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"log"</span>:&#123;</span><br><span class="line">        <span class="attr">"loglevel"</span>: <span class="string">"warning"</span>,</span><br><span class="line">        <span class="attr">"access"</span>: <span class="string">"/var/log/v2ray/access.log"</span>,</span><br><span class="line">        <span class="attr">"error"</span>:<span class="string">"/var/log/v2ray/error.log"</span></span><br><span class="line">    &#125;,</span><br><span class="line">  <span class="attr">"inbounds"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      "port": 1080, // 8080 or some port your want. 127.0.0.1:1080. for align proxy setting</span><br><span class="line">      "protocol": "socks",</span><br><span class="line">      "sniffing": &#123;</span><br><span class="line">        "enabled": true,</span><br><span class="line">        "destOverride": ["http", "tls"]</span><br><span class="line">      &#125;,</span><br><span class="line">      "settings": &#123;</span><br><span class="line">        "auth": "noauth"</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  "outbounds": [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"protocol"</span>: <span class="string">"vmess"</span>,</span><br><span class="line">      <span class="attr">"settings"</span>: &#123;</span><br><span class="line">        <span class="attr">"vnext"</span>: [</span><br><span class="line">          &#123;</span><br><span class="line">            "address" : "yourdomain.xxx", // your domain</span><br><span class="line">            "port": 443, // suggest 443, same when excute one line code on server</span><br><span class="line">           "users": [</span><br><span class="line">              &#123;</span><br><span class="line">                "id": "your server UUID", // same with server </span><br><span class="line">                "level" : 1,</span><br><span class="line">                "alterId": 16 // same with server</span><br><span class="line">              &#125;</span><br><span class="line">            ]</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;,</span><br><span class="line">	// different part from default</span><br><span class="line">        "streamSettings": &#123;</span><br><span class="line">          "network": "ws",</span><br><span class="line">          "security": "tls",</span><br><span class="line">          "wsSettings": &#123;</span><br><span class="line">            // same with server</span><br><span class="line">            "path": "/xxx222xxx/"</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"tag"</span>: <span class="string">"direct"</span>,</span><br><span class="line">      <span class="attr">"settings"</span>: &#123;&#125;,</span><br><span class="line">      <span class="attr">"protocol"</span>: <span class="string">"freedom"</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line"></span><br><span class="line">  "routing": &#123;</span><br><span class="line">    "domainStrategy": "IPOnDemand",</span><br><span class="line">    "rules": [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"type"</span>: <span class="string">"field"</span>,</span><br><span class="line">        <span class="attr">"ip"</span>: [</span><br><span class="line">          <span class="string">"geoip:private"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">"outboundTag"</span>: <span class="string">"direct"</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</details>

          
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
    </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://sogapalag.github.io/2020/02/24/Optimization-Technique/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhaopeng Yan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2020/02/24/Optimization-Technique/" class="post-title-link" itemprop="url">Optimization Technique</a>
              
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-02-24 21:59:19" itemprop="dateCreated datePublished" datetime="2020-02-24T21:59:19+08:00">2020-02-24</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2020-02-25 01:03:14" itemprop="dateModified" datetime="2020-02-25T01:03:14+08:00">2020-02-25</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/lecture/" itemprop="url" rel="index"><span itemprop="name">lecture</span></a></span>

                
                
              
            </span>
          

          <br>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h2 id="sum-on-slide-range-bounded-variable"><a href="#sum-on-slide-range-bounded-variable" class="headerlink" title="sum on slide-range bounded variable"></a>sum on slide-range bounded variable</h2><p>\begin{align}<br>  \sum_{i\leq j&lt;i+D} \max(f(i) + g(j), 0);<br>\end{align}<br>example: <a href="https://codeforces.com/contest/1313/problem/E" target="_blank" rel="noopener">cf1313e</a>, <a href="https://codeforces.com/contest/1311/problem/F" target="_blank" rel="noopener">cf1311f</a></p>
<details>
<summary> solution </summary>
note that
\begin{align}
  \max(x, 0) &= x \cdot [x > 0] \\
  \max(f+g,0) &= (f+g) \cdot [f > -g] = f \cdot [f>-g] + g \cdot [f>-g]
\end{align}
When fixed $i$, process all valid range $j$, maintain $\sum_g[f>-g]$ is count, $\sum_g g[f>-g]$ is partial-sum by two Fenwick trees. $O(n\log X)$

<p>one can see, there can be some variations, like min, or bounded other constant or plus some, and may not fixed $D$, as long as, valid range don’t vary large.</p>
</details>

<h2 id="expectation-of-bounded-X-Y"><a href="#expectation-of-bounded-X-Y" class="headerlink" title="expectation of bounded X+Y"></a>expectation of bounded X+Y</h2><p>\begin{align}<br>  \sum f(i) g(j) \cdot \max(i+j, D)<br>\end{align}<br>example: <a href="https://codeforces.com/contest/804/problem/D" target="_blank" rel="noopener">cf804d</a></p>
<details>
<summary> solution </summary>
first it's euiv to find
\begin{align}
  E[i+j-D] = \sum_{i+j>D} f(i)g(j) \cdot (i+j-D)
\end{align}
when apply $\sum p(X=x)x = \sum_{x>0} p(X\geq x)$, and fix $i$, one can notice we need multiply suffix of suffix of $g$ to $f$.

<p>or just maintain sum of $if$,$jg$,$f$,$g$, note sum $jg$ is indeed corresponding to suffix twice. $O(n)$</p>
</details>

          
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
    </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://sogapalag.github.io/2020/02/22/Advanced-DP-Technique/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhaopeng Yan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2020/02/22/Advanced-DP-Technique/" class="post-title-link" itemprop="url">Advanced DP Technique</a>
              
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-02-22 19:04:42 / Modified: 20:32:26" itemprop="dateCreated datePublished" datetime="2020-02-22T19:04:42+08:00">2020-02-22</time>
            </span>
          
            

            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/lecture/" itemprop="url" rel="index"><span itemprop="name">lecture</span></a></span>

                
                
              
            </span>
          

          <br>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h2 id="Intro"><a href="#Intro" class="headerlink" title="Intro"></a>Intro</h2><p>What kind of technique is advanced? Some well-known tech like, bitmask, bitset, digit, segment, I might not include it. And dp with monotonic queue, segment-tree, convex-hull are well known, too; but I might include it. For now, I wish include it about codeforces-2500 or atcoder-1000.</p>
<h3 id="abs-cost-adj-constraints"><a href="#abs-cost-adj-constraints" class="headerlink" title="abs-cost, adj-constraints"></a>abs-cost, adj-constraints</h3><p>Problem description: given $z_{1..n}$, try mini $\sum_{i} |z_i - x_i|$, with adj-constratins, $x_{i-1} \in [x_i-l_i, x_i+r_i]$<br>example: <a href="https://codeforces.com/contest/372/problem/C" target="_blank" rel="noopener">cf372c</a>, <a href="https://atcoder.jp/contests/arc070/tasks/arc070_c" target="_blank" rel="noopener">arc070e</a>, <a href="https://codeforces.com/contest/713/problem/C" target="_blank" rel="noopener">cf713c</a><br>\begin{align}<br>  dp[i][x] = |z_i - x| + \min_{x’ \in [x-l_i, x+r_i]}dp[i-1][x’]<br>\end{align}</p>
<details>
<summary> solution $O(n \log n)$ </summary>
let $f_i(x) = dp[i][x]$, the key conclusion is $f_i(x)$ is a segline function with slope $-i,-i+1,..,-1,0,1,..i-1,i$. first it's easy to note segline function plus $|z-x|$ is segline function, since it make left/right slope $-+1$.

<p>now we use two heap maintain slope $\leq 0$ and $\geq 0$ turnning points. call it L/R part. let $L_0$ be L.top(), i.e. slope $-1,0$ turnning point, note if $x+r_i \leq L_0$, means whole valid range fall into L part, if $x-l_i \geq R_0$, fall into R part, other case the range contain part of slope 0. Thus<br>\begin{align}<br>  g(x) = \min_{x’\in[x-l_i, x+r_i]} f_{i-1}(x’) =<br>  \begin{cases}<br>    f_{i-1}(x + r_i), x+r_i \leq L_0  \\<br>    f_{i-1}(x - l_i), x-l_i \geq R_0  \\<br>    C=f_{i-1}(L_0)=f_{i-1}(R_0), \text{otherwise}<br>  \end{cases}<br>\end{align}<br>i.e. $g(x)$ is obtained by shift L $-r_i$, and shift R $l_i$.</p>
<p>then for $|z-x|$, we consider which part $z$ fall into, push new turnning point, and update $C$.</p>
</details>

          
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
    </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://sogapalag.github.io/2020/02/22/Complexity-Analysis-of-DP-on-Tree/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhaopeng Yan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2020/02/22/Complexity-Analysis-of-DP-on-Tree/" class="post-title-link" itemprop="url">Complexity Analysis of DP on Tree</a>
              
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-02-22 13:57:37 / Modified: 16:50:34" itemprop="dateCreated datePublished" datetime="2020-02-22T13:57:37+08:00">2020-02-22</time>
            </span>
          
            

            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/lecture/" itemprop="url" rel="index"><span itemprop="name">lecture</span></a></span>

                
                
              
            </span>
          

          <br>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>This lecture is mainly focusing on time complexity analysis of some known dp technique on tree. e.g. small-to-large, convolution. etc. wlog let $f(u)$ be required operation at vertex $u$. note we ignore container complexity, e.g. set or map.</p>
<h2 id="move-and-merge"><a href="#move-and-merge" class="headerlink" title="move and merge"></a>move and merge</h2><p>In some case $\text{dp}[v]$ can become $\text{dp}[u]$ in $O(1)$ operation, e.g.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">std</span>::move</span><br></pre></td></tr></table></figure>

<p>or</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">std</span>::swap</span><br></pre></td></tr></table></figure>

<p>so we let some max identity child be first, then merge remains.</p>
<h3 id="pass-max-sub-size"><a href="#pass-max-sub-size" class="headerlink" title="pass max sub-size"></a>pass max sub-size</h3><p>\begin{align}<br>  f(u) &amp;= \sum_{i\neq 0} \text{sz}[v_i] = \text{sz}[u] - \max_i \text{sz}[v_i] \\<br>  \Rightarrow F &amp;= O(n \log n)<br>\end{align}</p>
<details>
<summary> proof </summary>
for any small child, note $\text{sz}[u] > 2 \cdot \text{sz}[v]$, so each time if subtree of $v$ need merge, total size increas at least twice, since which is bounded by $n$. i.e. for each node $x$, it can remain small subtree at most $O(\log n)$ turns(not necessary consective).
</details>

<h4 id="huffman’s"><a href="#huffman’s" class="headerlink" title="huffman’s"></a>huffman’s</h4><p>what if we merge subtree like huffman’s, i.e. greedy small-to-large, and ignore heap complexity, can we get better complexity?</p>
<p>No, consider a complete binary tree, note at each depth, you have to do $O(n)$ merge. so $O(n \log n)$.</p>
<h3 id="pass-max-sub-depth"><a href="#pass-max-sub-depth" class="headerlink" title="pass max sub-depth"></a>pass max sub-depth</h3><p>let $\text{arm}[u]$ be max-depth of leaf of subtree of $u$.</p>
<p>\begin{align}<br>  f(u) &amp;= \sum_{i\neq 0} \text{arm}[v_i] \\<br>  \Rightarrow F &amp;= O(n)<br>\end{align}</p>
<details>
<summary> proof </summary>
One might consider if some arm $v$ keep small, as long as future arm $d, d+1, d+2, ...$, then thought $O(n\sqrt{n})$. But this doesn't fit our intuition, since we maintain arm$\leq$sz. And one can see a construction depth $1,2,3,...\sqrt{n}$, only main path need merge, and is $n$.

<p>Fix some depth, let $k$ be number of nodes in this depth, note only when $k&gt;1$ we need merge, and apparently $k$ piles, after $k-1$ merge become $1$. So $F = \sum k-1 = O(n)$.</p>
</details>


<h2 id="convolution"><a href="#convolution" class="headerlink" title="convolution"></a>convolution</h2><h3 id="convolution-on-sub-size"><a href="#convolution-on-sub-size" class="headerlink" title="convolution on sub-size"></a>convolution on sub-size</h3><p>\begin{align}<br>  f(u) &amp;= \sum_{i} (\sum_{j&lt;i} \text{sz}[v_j])\cdot \text{sz}[v_i] \\<br>  \Rightarrow F &amp;= O(n^2)<br>\end{align}</p>
<details>
<summary> proof </summary>
note $f(u)$ is indeed number of pair nodes, $(x,y)$ s.t. $\text{lca}(x,y) = u$. Thus $F=O(n^2)$.
</details>

          
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
    </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://sogapalag.github.io/2020/01/07/Inclusion-Exclusion-Principle/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhaopeng Yan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2020/01/07/Inclusion-Exclusion-Principle/" class="post-title-link" itemprop="url">Inclusion Exclusion Principle</a>
              
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-01-07 22:33:11" itemprop="dateCreated datePublished" datetime="2020-01-07T22:33:11+08:00">2020-01-07</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2020-01-10 15:31:10" itemprop="dateModified" datetime="2020-01-10T15:31:10+08:00">2020-01-10</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/lecture/" itemprop="url" rel="index"><span itemprop="name">lecture</span></a></span>

                
                
              
            </span>
          

          <br>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>This technique is widely used in counting. In general, it is related to poset theory, while mobius on number theory is given in another lecture, so this note is focus on finite set $[n]$, since infinite set is less used in competitive programming. Anyway, now we focus on poset $(\Omega=2^{[n]}, \subseteq)$. And we will discuss its variation and related problem.</p>
<h2 id="Preliminary"><a href="#Preliminary" class="headerlink" title="Preliminary"></a>Preliminary</h2><p>Before given the most popular formula, I just give the general formulas. and I will use $D\subseteq N$ notation, for similar to nt $d|n$, one can aware which is subset, which is superset.</p>
<p>Zeta transform(subset, down): $F(N) = \sum_{D\subseteq N} f(D)$. write as $F=\boldsymbol{Z}f$. or $F(N)=zf(D)$.</p>
<p>Mobius transform(inversion): $f(N) = \sum_{D\subseteq N} (-1)^{|N - D|} F(D)$. w.as $f = \boldsymbol{M}F$. or $f(N)=mF(D)$.</p>
<p>Zeta transform(on superset, up): $F(D) = \sum_{D\subseteq N} f(N)$. w.as $F=\boldsymbol{Z}_p f$. or $F(D)=zf(N)$.</p>
<p>Mobius transform(up): $f(D) = \sum_{D\subseteq N} (-1)^{|N-D|}F(N)$. w.as $f=\boldsymbol{M}_p F$. or $f(D)=mF(N)$.</p>
<p>basic relations:<br>\begin{align} \boldsymbol{MZ} = \boldsymbol{ZM} = I \\<br>   \boldsymbol{M_pZ_p} = \boldsymbol{Z_pM_p} = I<br>\end{align}</p>
<hr>
<p><strong>popular form</strong>:</p>
<p>we use notation $A_J = \bigcap_{j\in J} A_j$.</p>
<p>\begin{align}<br>  |\bigcup_{i\in [n]} A_i| = \sum_{\emptyset \neq J \subseteq [n]} (-1)^{|J|+1} |A_J| \\<br>  |\bigcap_{i\in [n]} A_i^c| = |S -\bigcup_{i\in [n]} A_i | = |S| + \sum_{\emptyset \neq J \subseteq [n]} (-1)^{|J|} |A_J|<br>\end{align}</p>
<details>
<summary> corresponding to general form </summary>
  note $|A_J|$ is number of with properties superset to $J$, denote as $F(J)$. so recall $Z_p$. second formula LHS is $f(\emptyset)$ with zero property.
</details>

<p>and we sometimes use probability form by replace $|.|$ with prob$(.)$.</p>
<hr>
<p><strong>maximum minimum identity</strong>:</p>
<p>we use notation $\min x_J = \min_{j\in J} x_j$.<br>\begin{align}<br>  \max \{ x_1, x_2, …, x_n \} = \sum_{\emptyset \neq J \subseteq [n]} (-1)^{|J|+1}\min x_J \\<br>  \min \{ x_1, x_2, …, x_n \} = \sum_{\emptyset \neq J \subseteq [n]} (-1)^{|J|+1}\max x_J<br>\end{align}</p>
<details>
<summary> proof hint </summary>
let $U$ uniform r.v., let $A_i=\{ U < x_i \}$. detail could be find on "A first course in probability".
</details>

<p>random variable $X_i$ still hold. i.e.<br>\begin{align}<br>  \max_{i\in [n]} X_i = \sum_{\emptyset \neq J \subseteq [n]} (-1)^{|J|+1}\min X_J \\<br>  \min_{i\in [n]} X_i = \sum_{\emptyset \neq J \subseteq [n]} (-1)^{|J|+1}\max X_J<br>\end{align}</p>
<p>by linearty of expectation, we can attach $E$ get<br>\begin{align}<br>  E[\max_{i\in [n]} X_i] = \sum_{\emptyset \neq J \subseteq [n]} (-1)^{|J|+1} E[\min X_J] \\<br>  E[\min_{i\in [n]} X_i] = \sum_{\emptyset \neq J \subseteq [n]} (-1)^{|J|+1} E[\max X_J]<br>\end{align}</p>
<h3 id="more-corollary-formulas"><a href="#more-corollary-formulas" class="headerlink" title="more corollary formulas"></a>more corollary formulas</h3><p>Since sometimes corollary might more helpful than vanilla.</p>
<p>notation: $f_d = \sum_{|D|=d} f(D)$.</p>
<p>\begin{align}<br>  f_d = \sum_{k=d}^n (-1)^{k-d} {k \choose d} \sum_{|N|=k} F_p(N)<br>\end{align}</p>
<details>
<summary> proof </summary>
"A course in eumeration" page 185. but note that our $f$ is not nessary number of count, is much more general function. recall formual(17) of page 186.
\begin{align}
  f_d &= \sum_{|D|=d}f(D) = \sum_{|D|=d}\sum_{D\subseteq N} (-1)^{|N-D|} F_p(N) \\\\
   &= \sum_{|N|\geq d} (-1)^{|N|-d} \sum_{|D|=d, D\subseteq N} F_p(N) \\\\
   &= \sum_{k=d}^n (-1)^{k-d} {k\choose d} \sum_{|N|=k} F_p(N)
\end{align}
</details>

<p>thus, sometimes we face multi-dimension problem, and want count number with exact $d$ properties, we can use $F_p(N)$ i.e. superset of properties, (or at least the properties) to deduce that.</p>
<p>when $f(D)$ only depend on its size $|D|=d$. called <strong>homogeneous</strong>. and we use notation $F_{\geq k} = F_p(|N|=k)$. then we get a spectial formula.<br>\begin{align}<br>  f_d = {n\choose d} \sum_{k=d}^n (-1)^{k-d} {n-d \choose k-d} F_{\geq k}<br>\end{align}<br>Be careful $F_{\geq k} = \sum_{K\subseteq X} f(X)$, for some $|K|=k$, $\neq \sum_{|X|\geq k} f(X)$.</p>
<p>by let $f$ be prob, we can get $E[|D|]=\sum_{|N|=1}F_p(N)$, which is sum of indicators of course.</p>
<h2 id="Problems"><a href="#Problems" class="headerlink" title="Problems"></a>Problems</h2><p>IEP has simple and elegant formula, but problem solving is hard sometimes. The hard part is find suitable space, once this is done, everything will be easy.</p>
<hr>
<p><a href="https://csacademy.com/contest/archive/task/distinct_neighbours/" target="_blank" rel="noopener">distinct neighbours</a>, <a href="https://codeforces.com/contest/840/problem/C" target="_blank" rel="noopener">cf840c</a>.</p>
<details>
<summary> solution </summary>
the widely used solution is $O(n^3)$ dp, but there is a $O(n^2)$ IEP solution. the answer is
\begin{align}
  \sum_{d\leq a} \prod_{i}(-1)^{a_i-d_i} p(a_i,d_i) {\sum d_i \choose d_i,...}
\end{align}
by consider $I_{i,j}$ the $j$th adj-pair of group $i$ is same. And we want $I_0$. where $p(n,k)$ denote ways of $k$ positives sum $=n$. Besides, for this problem, homogeneous on vector $d$.
</details>

<hr>
<p><strong>Coupon collector problem</strong></p>
<p>The classic equal probability can be solved by consider order statistics $1_{(i)}$ the time needed to get next type. Answer is $nH_n$.</p>
<p><a href="https://csacademy.com/contest/archive/task/ball-sampling/" target="_blank" rel="noopener">unequal probability</a></p>
<details>
<summary> solution </summary>
despite the ordinary $O(n2^n)$ dp. There is IEP $O(\sum a)$. Recall text of "prob", let $I_i$ be the moment collect $i$th type, by max-min identity. The answer is
\begin{align}
  E = \sum_{\emptyset\neq J\subseteq [n]} (-1)^{|J|+1}\frac{1}{\sum_{j\in J}p_j}
\end{align}
</details>

<p>when type $i$ need reach $b_i$. <a href="https://atcoder.jp/contests/agc038/tasks/agc038_e" target="_blank" rel="noopener">agc038e</a></p>
<details>
<summary> solution </summary>
Give answer first
\begin{align}
  E = \sum_{k=1}^n (-1)^{k+1} \sum_{|J|=k,d_j < b_j} \frac{\sum a}{\sum_J a} {\sum_J d \choose d_j,...} \prod_{j} (\frac{a_j}{\sum_J a})^{d_j}
\end{align}
Which is easy to understand the form, for fixed size, the probability hit the state, and expectation of lasting time on the state. Make sense, but I didn't find any rigorous proof otherwhere.

<p>First note each roll, we at some state by vector $d=(…)$ where $d_i \leq b_i$, and game ends at $d=b$. Let $I_i$ be the property $d_i &lt; b_i$, i.e. not full yet. Then we want $\bigcup_i I_i$. Thus we can apply IEP, as long as we can get $I_J=\bigcap_{j\in J} I_j$ i.e. the count of $J$ set all not full yet. Which<br>\begin{align}<br>  I_J = \sum_{d_j&lt;b_j} \text{Prob}(\text{hit d}|J) \cdot \text{Eexpected time stay at d}<br>\end{align}<br>Another method is let $X_i$ be the moment $d_i=b_i$ i.e. type $i$ is full. Then by max-min identity, we need get $\min_J X$ which is exactly $I_J$. since find first hit one of $J$ is same to find all $d_j&lt;b_j$.</p>
</details>

          
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
    </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://sogapalag.github.io/2019/12/20/Mobius-Inversion/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhaopeng Yan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/12/20/Mobius-Inversion/" class="post-title-link" itemprop="url">Mobius Inversion</a>
              
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-12-20 20:13:05" itemprop="dateCreated datePublished" datetime="2019-12-20T20:13:05+08:00">2019-12-20</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2020-01-07 23:57:47" itemprop="dateModified" datetime="2020-01-07T23:57:47+08:00">2020-01-07</time>
              </span>
            
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/lecture/" itemprop="url" rel="index"><span itemprop="name">lecture</span></a></span>

                
                
              
            </span>
          

          <br>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>This note is about number theory related to poset(or lattice), i.e. on $(\mathbb{N}^+, |)$. where $|$ is correspoding to $\leq$, gcd c.to meet $x\wedge y$, lcm c.to join $x\vee y$. According to lattice theory, we has some zeta and mobius transform properties. Besides another useful lattice is $(S, \subseteq)$ which also has those properties. Anyway this lecture is focus on number theory.</p>
<h2 id="Preliminary"><a href="#Preliminary" class="headerlink" title="Preliminary"></a>Preliminary</h2><p>Check wiki for: mobius function $\mu$, euler totient function $\phi$.</p>
<p>Zeta transform(on subset, down): $F(n) = \sum_{d|n} f(d)$. write as $F=\boldsymbol{Z}f$.</p>
<p>Mobius transform(inversion): $f(n) = \sum_{d|n} \mu(n/d) F[d]$. w.as $f = \boldsymbol{M}F$.</p>
<p>Zeta transform(on superset, up): $F(d) = \sum_{d|n} f(n)$. w.as $F=\boldsymbol{Z}_p f$.</p>
<p>Mobius transform(up): $f(d) = \sum_{d|n} \mu(n/d)F(n)$. w.as $f=\boldsymbol{M}_p F$.</p>
<p>Dirichlet convolution: $(f*g)(n) = \sum_{d|n} f(d)g(n/d)$.</p>
<p>And some basic function: $\epsilon(n) = [n=1]$, $I(n) = n$. $1(n) = 1$. $d(n)=\sum_{d|n}1$. </p>
<p>Also transform can be written in Dirichlet convolution form:<br>\begin{align} F = \boldsymbol{Z}f \Leftrightarrow F = f*1 = 1*f  \\<br>   f = \boldsymbol{M}F \Leftrightarrow f = F*\mu = \mu*F<br>\end{align}</p>
<p>Basic relations:<br>\begin{align} \boldsymbol{MZ} = \boldsymbol{ZM} = I \\<br>   \boldsymbol{M_pZ_p} = \boldsymbol{Z_pM_p} = I \\<br>   \epsilon = \boldsymbol{Z}\mu = \mu*1 \\<br>   I = \boldsymbol{Z}\phi = \phi*1 \Leftrightarrow \phi = \boldsymbol{M}I = \mu * I<br>\end{align}</p>
<h2 id="Useful-formula"><a href="#Useful-formula" class="headerlink" title="Useful formula"></a>Useful formula</h2><p>\begin{align} \sum_{i=1}^a \sum_{j=1}^b \sum_{k=1}^c d(ijk) = \sum_{i|a,j|b,k|c}[(i,j)=1][(i,k)=1][(j,k)=1] = \sum_{(i,j)=1,(i,k)=1,(j,k)=1} \lfloor \frac{a}{i}\rfloor \lfloor \frac{b}{j} \rfloor \lfloor \frac{c}{k} \rfloor \end{align}, where $(i,j)$ means $gcd(i,j)$. <a href="https://blog.csdn.net/V5ZSQ/article/details/78951025" target="_blank" rel="noopener">chinese proof</a>, <a href="http://rng.gozaru.jp/b.pdf" target="_blank" rel="noopener">english proof</a>. example <a href="https://codeforces.com/problemset/problem/235/E" target="_blank" rel="noopener">cf235e</a>.</p>
<hr>
<p>\begin{align} \sum I\cdot f = \sum \phi \cdot F_p \end{align}. where $F_p=\boldsymbol{Z_p} f$. before give proof, let us define a notation, $z=\sum_{d|n}$, $m=z \mu(n/d)=\sum_{d|n}\mu(n/d)$, view it as $(d,n)$ space constraints. Now we can write transform also as:</p>
<p>zeta: $F(n)=zf(d)$</p>
<p>mobius: $f(n)=mF(d)$</p>
<p>zeta(up): $F(d)=zf(n)$</p>
<p>mobius(up): $f(d)=mF(n)$</p>
<details>
<summary> proof </summary>
\begin{align}\sum_{d=1}^N I(d) f(d) &= \sum_{d=1}^N I(d) m F(n) \\\\
  &= z I(d)\mu(n/d) F(n) \\\\
  &= \sum_{n=1}^N F(n) z \mu(n/d)I(d) \\\\
  &= \sum_{n=1}^N F(n) mI(d) \\\\
  &= \sum_{n=1}^N F(n) \phi(n)
\end{align}
or if you view as all the sum as constraint, do it without fear
\begin{align} \sum I(d)f(d) &= \sum I(d)mF(n) \\\\
  &= \sum F(n) mI(d) \\\\
  &= \sum F(n)\phi(n)
\end{align}
</details>

<p>example <a href="https://codeforces.com/contest/645/problem/F" target="_blank" rel="noopener">cf645f</a></p>
<p>And we can generalized above formula<br>\begin{align} \sum f\cdot G = \sum F_p \cdot g<br>\end{align}<br>with $I=\sigma*\mu$, $1=d*\mu$.</p>
<hr>
<p>\begin{align} \boldsymbol{Z}^r = {\text{multi-chains of length }r}<br>\end{align}<br>i.e. if $F(n)=\boldsymbol{Z}^{r+1} f(d)$, then $F(n)=\boldsymbol{Z} c(n\rightarrow d)f(d)$, where $c(n\rightarrow d)$ is count of lattice $n$ down to $d$. hint: prime independent, distribute exponents on $r$ edges. example <a href="https://codeforces.com/problemset/problem/757/E" target="_blank" rel="noopener">cf757e</a></p>

          
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
    </footer>
  </div>
  
  
  
  </article>

    
      

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://sogapalag.github.io/2019/10/18/How-to-hit-codeforces-rating-2000-in-half-year/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhaopeng Yan">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/10/18/How-to-hit-codeforces-rating-2000-in-half-year/" class="post-title-link" itemprop="url">How to hit codeforces rating 2000 in half year</a>
              
            
          </h1>
        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-10-18 14:16:11" itemprop="dateCreated datePublished" datetime="2019-10-18T14:16:11+08:00">2019-10-18</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2021-03-30 19:20:11" itemprop="dateModified" datetime="2021-03-30T19:20:11+08:00">2021-03-30</time>
              </span>
            
          

          <br>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
            <h2 id="From-0-to-2000"><a href="#From-0-to-2000" class="headerlink" title="From 0 to 2000"></a>From 0 to 2000</h2><p>  0 means competitive programming newbie. Although I graduate from CS college, then after waste another several years, I didn’t remember anything useful. I’ve writen less 1000 lines code, in two years before start contesting. I don’t familiar dijkstra or any basic algorithms. So I’m totally newbie on coding.</p>
<p>  Well, I’m not 0 much, since I do have some math background.</p>
<p>  Keep practicing, keep contesting, keep up-solving. In the beginning, you need to be familiar plenty of basic algorithms. dfs/bfs, double pointer, divide&amp;conquer, etc.. and ds like dsu, these might help you to hit 1600.</p>
<p>  Then you need to familiar BIT(Fenwick), segment-tree, bitmask dp.. this might help you to hit 1800.</p>
<p>  There are some well-known advanced(than basic, not used very much) algos. here advanced I mean they’re not used very often as BIT. e.g. z’s algo, suffix array, mcmf, 2-sat, CHT, fft, rolling hash, kmp, spaly tree, etc..</p>
<p>  So advice for learning, based on frequency of problems’ topics.</p>
<p>  If you least most algorithms, and pay consistent practicing, then you will hit 2000 with high probability. Although most problems is not about how to impl, is about how to cut problem to pieces, or find special properties. And if you know many counting technique or combitorial knowledge, might helpful.</p>
<h2 id="Weakness"><a href="#Weakness" class="headerlink" title="Weakness"></a>Weakness</h2><p>  Since half year is very short time compared to time devoted by experienced coder. You might stuck at some easy part, but well-known to the community. Coding speedness is matter, and heavy impl is painful. (English reading is cost too much time for non-native speaker)</p>
<p>  For myself, there are some problems is hard, but I can solve it when off-contest, some even can’t when off-contest. In general, I don’t think I perform well on contest, there are always some problems I didn’t solve it on the contest, but solve it off-contest. So perform normal can help me to hit 2000. I believe if pay much time, you will hit higher.</p>
<h2 id="For-hard-problems"><a href="#For-hard-problems" class="headerlink" title="For hard problems"></a>For hard problems</h2><p>  There are some problems might beyond your ability now, and you can’t measure whether you can solve it or not. Well I believe more than 80% although you can’t understand in first place, but keep reading editorial, read others’ comments, read others’ code, you will get the idea. It’s all about logic, once you get the key logic, everything is easy then.</p>

          
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
    </footer>
  </div>
  
  
  
  </article>

    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>


          </div>
          

        </div>
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">

          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Zhaopeng Yan</p>
  <div class="site-description motion-element" itemprop="description"></div>
</div>
  <nav class="site-state motion-element">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">12</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-categories">
        
          
            <a href="/categories/">
          
        
        
        
          
        
          
        
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">categories</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-tags">
        
          
            <a href="/tags/">
          
        
        
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <span class="site-state-item-count">30</span>
        <span class="site-state-item-name">tags</span>
        </a>
      </div>
    
  </nav>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
      
      
        
      
      
        
      
        <a href="https://github.com/sogapalag" title="GitHub &rarr; https://github.com/sogapalag" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
    
  </div>



        </div>
      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zhaopeng Yan</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.9.0</div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.3.0</div>

        








        
      </div>
    </footer>
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
      </div>

    

  </div>

  
    
    
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/jquery/index.js?v=3.4.1"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  <script src="/js/utils.js?v=7.3.0"></script>
  <script src="/js/motion.js?v=7.3.0"></script>

  
  <script src="/js/affix.js?v=7.3.0"></script>
  <script src="/js/schemes/pisces.js?v=7.3.0"></script>



  

  <script src="/js/next-boot.js?v=7.3.0"></script>

  

  

  


  





  
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  
    
      <script type="text/x-mathjax-config">

  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$', '$'], ['\\(', '\\)'] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
      equationNumbers: {
        autoNumber: 'AMS'
      }
    }
  });

  MathJax.Hub.Register.StartupHook('TeX Jax Ready', function() {
    MathJax.InputJax.TeX.prefilterHooks.Add(function(data) {
      if (data.display) {
        var next = data.script.nextSibling;
        while (next && next.nodeName.toLowerCase() === '#text') {
          next = next.nextSibling;
        }
        if (next && next.nodeName.toLowerCase() === 'br') {
          next.parentNode.removeChild(next);
        }
      }
    });
  });

  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for (i = 0; i < all.length; i += 1) {
      element = document.getElementById(all[i].inputID + '-Frame').parentNode;
      if (element.nodeName.toLowerCase() == 'li') {
        element = element.parentNode;
      }
      element.classList.add('has-jax');
    }
  });
</script>
<script src="//cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    
  
































</body>
</html>
